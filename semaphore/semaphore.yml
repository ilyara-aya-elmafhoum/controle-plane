blocks:
  - name: Terraform Apply
    task:
      secrets:
        - name: terraform
      jobs:
        - name: Create control-plane
          commands:
            - checkout
            - cd repository_1_template_1/terraform
            
            # CrÃ©er terraform.tfvars depuis les variables d'environnement
            - |
              cat > terraform.tfvars << EOF
              openstack_cloud = "$TF_VAR_openstack_cloud"
              OS_USERNAME = "$TF_VAR_OS_USERNAME"
              OS_PASSWORD = "$TF_VAR_OS_PASSWORD"
              OS_PROJECT_NAME = "$TF_VAR_OS_PROJECT_NAME"
              OS_auth_url = "$TF_VAR_OS_auth_url"
              sysadmin_pub_key = "$TF_VAR_sysadmin_pub_key"
              devops_aya_pub_key = "$TF_VAR_devops_aya_pub_key"
              terraform_bot_pub_key = "$TF_VAR_terraform_bot_pub_key"
              vm_flavor = "$TF_VAR_vm_flavor"
              vm_image = "$TF_VAR_vm_image"
              floating_ip_pool = "$TF_VAR_floating_ip_pool"
              admin_cidr = "$TF_VAR_admin_cidr"
              EOF
            
            # Debug
            - echo "=== Contenu de terraform.tfvars ==="
            - cat terraform.tfvars
            
            - terraform init -input=false
            - terraform plan -var-file=terraform.tfvars -input=false
            - terraform apply -var-file=terraform.tfvars -auto-approve -input=false
            
            - terraform output -raw controle_plane_ip > ../ansible/control_plane_ip.txt